{% load static %}
{% block cssfiles %}
<link rel="stylesheet" href="{% static 'css/employee.css' %}">
{% endblock %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create Employee</title>
</head>
<body>
  <!-- Navbar -->
  <header class="navbar">
      <h2 class="logo">Employee Management</h2>
      <nav>
          <a href="/accounts/dashboard/">Dashboard</a>
          <a href="/accounts/profile/">Profile</a>
          <a href="/accounts/logout/">Logout</a>
      </nav>
  </header>

  <div class="container">
    <h1>Create Employee</h1>

    <!-- Form Selection -->
    <div class="form-select">
      <label for="formSelect">Select Form:</label>
      <select id="formSelect" onchange="loadFormFields()">
          <option value="">-- Select a Form --</option>
          {% for form in forms %}
            <option value="{{ form.id }}">{{ form.name }}</option>
          {% endfor %}
      </select>
    </div>

    <hr>

    <!-- Employee Form -->
    <form id="employeeForm" onsubmit="submitEmployee(event)">
      <div id="dynamicFields"></div>
      <button type="submit" class="btn-primary">Save Employee</button>
    </form>
  </div>

  <script>
    {{ block.super }}
    async function loadFormFields() {
      const formId = document.getElementById("formSelect").value;
      if (!formId) return;    
      const response = await fetch(`/accounts/employee/get-form-fields/${formId}/`);
      const data = await response.json();

      const container = document.getElementById("dynamicFields");
      container.innerHTML = "";

      if (data.success) {
        data.fields.forEach(field => {
          let inputElement = "";

          if (["text","email","date","number","password"].includes(field.field_type)) {
            inputElement = `<input type="${field.field_type}" 
                                    name="field_${field.id}" 
                                    placeholder="${field.placeholder}" 
                                    ${field.required ? "required" : ""}>`;
          } else if (field.field_type === "textarea") {
            inputElement = `<textarea name="field_${field.id}" 
                                      placeholder="${field.placeholder}" 
                                      ${field.required ? "required" : ""}></textarea>`;
          } else if (field.field_type === "select") {
            inputElement = `<select name="field_${field.id}">` +
                            field.options.map(opt => `<option value="${opt}">${opt}</option>`).join("") +
                          `</select>`;
          } else if (field.field_type === "radio") {
            inputElement = field.options.map(opt => `
              <label><input type="radio" name="field_${field.id}" value="${opt}"> ${opt}</label>
            `).join("");
          } else if (field.field_type === "checkbox") {
            inputElement = field.options.map(opt => `
              <label><input type="checkbox" name="field_${field.id}" value="${opt}"> ${opt}</label>
            `).join("");
          }

          container.innerHTML += `
            <div class="field-block">
              <label>${field.label}${field.required ? " *" : ""}</label><br>
              ${inputElement}
              <small>${field.help_text || ""}</small>
            </div>
          `;
        });
      }
    }

    async function submitEmployee(event) {
      event.preventDefault();

      const formId = document.getElementById("formSelect").value;
      if (!formId) {
        alert("Please select a form first!");
        return;
      }

      const formData = new FormData(document.getElementById("employeeForm"));
      const fields = [];

      const checkboxes = {};
      document.querySelectorAll("input[type=checkbox]").forEach(cb => {
        if (!checkboxes[cb.name]) checkboxes[cb.name] = [];
        if (cb.checked) checkboxes[cb.name].push(cb.value);
      });

      for (let [key, value] of formData.entries()) {
        if (key.startsWith("field_")) {
          const fieldId = key.split("_")[1];
          if (checkboxes[key]) {
            fields.push({ field_id: fieldId, value: checkboxes[key].join(", ") });
          } else {
            fields.push({ field_id: fieldId, value: value });
          }
        }
      }

      const response = await fetch("/accounts/employee/save/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ form_id: formId, fields: fields })
      });

      const data = await response.json();
      if (data.success) {
        alert(data.message);
        window.location.reload();
      } else {
        alert("Error: " + data.error);
      }
    }
  </script>
</body>
</html>
